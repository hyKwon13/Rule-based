# 회전 기반 Rule-Based 객체 탐지

<table>
  <tr>
    <td>
      <img src="https://github.com/hyKwon13/Rule-based/blob/9175539e738402dfbb68ccbe8547e5da4f5a6b26/image/rotate2.png" alt="Rotate Example 1" width="300">
    </td>
    <td>
      <img src="https://github.com/hyKwon13/Rule-based/blob/9175539e738402dfbb68ccbe8547e5da4f5a6b26/image/rotate3.png" alt="Rotate Example 2" width="300">
    </td>
  </tr>
</table>

## **배경**

이 프로젝트는 **딥러닝을 사용하지 않고도 객체를 탐지**할 수 있는 시스템을 구축하기 위해 개발되었습니다. Rule-Based 기법을 사용함으로써, 데이터셋이나 사전 학습 모델 없이도 객체 탐지가 가능합니다.

기존의 객체 탐지 기법은 대부분 객체의 위치만을 탐지하며, **회전된 객체를 고려하지 않는 경우가 많습니다**. 이를 해결하기 위해 OpenCV의 `matchTemplate` 함수와 회전각도를 결합하여 다양한 방향의 객체를 탐지할 수 있는 시스템을 설계했습니다. 특히, **회전행렬과 같은 수학적 기법**을 활용하여 회전을 정밀하게 반영합니다.

---

## **주요 특징**

- **Rule-Based 탐지**: 학습이나 데이터셋 없이 객체 탐지 가능.
- **회전 반영**: 객체의 ±30°(조정시 ±180°) 회전 탐지 가능.
- **실시간 탐지**: 웹캠을 활용한 실시간 객체 탐지.
- **마우스 기반 ROI 선택**: 사용자가 마우스로 ROI(관심 영역)를 설정 가능.

---

## **작동 원리**

### 1. **템플릿 생성**
1. **ROI(관심 영역) 설정**: 사용자가 영상에서 탐지할 객체의 영역을 마우스로 선택합니다.
2. **ROI 전처리**:
   - 그레이스케일 변환: ROI를 그레이스케일로 변환해 연산 효율을 높임.
   - 에지 검출: Canny 에지 검출기를 사용해 객체의 윤곽선을 강조.
3. **회전 템플릿 생성**:
   - ROI를 기준으로 여러 각도로 회전된 템플릿을 생성하여 다양한 방향성을 고려.

---

### 2. **템플릿 매칭과 회전**

#### **회전 행렬**
ROI의 이미지를 회전시키기 위해 **2D 회전 행렬**을 사용합니다. 회전 행렬은 다음과 같이 계산됩니다:

<table>
  <tr>
    <td>M = </td>
    <td>
      <pre>
      [ cos(θ)  -sin(θ)   (1 - cos(θ)) ⋅ c_x + sin(θ) ⋅ c_y ]
      [ sin(θ)   cos(θ)   (1 - cos(θ)) ⋅ c_y - sin(θ) ⋅ c_x ]
      </pre>
    </td>
  </tr>
</table>
<p>
  <b>θ</b>: 회전 각도(라디안 단위)<br>
  <b>(c<sub>x</sub>, c<sub>y</sub>)</b>: 회전 중심(ROI의 중심점)
</p>

이 회전 행렬을 OpenCV의 `warpAffine` 함수와 결합하여 템플릿을 회전시킵니다.

---

#### **매칭 알고리즘**
각 회전 템플릿과 현재 프레임을 비교하여 가장 적합한 템플릿과 위치를 탐지합니다. 이 과정에서 `matchTemplate` 함수의 **상관 계수 정규화(CCOEFF_NORMED)** 방법을 사용합니다.

매칭 점수는 다음 수식으로 계산됩니다:

<table>
  <tr>
    <td>
      match_value =
    </td>
    <td>
      <pre>
        Σ (T(x, y) - T̄)(I(x, y) - Ī)
      --------------------------------
      √[Σ (T(x, y) - T̄)² ⋅ Σ (I(x, y) - Ī)²]
      </pre>
    </td>
  </tr>
</table>

<p>
  <b>T(x, y)</b>: 템플릿 픽셀 값<br>
  <b>I(x, y)</b>: 프레임 픽셀 값<br>
  <b>T̄, Ī</b>: 템플릿과 프레임의 평균값
</p>

가장 높은 매칭 값을 가진 템플릿의 위치와 각도를 최종적으로 탐지합니다.

---

### 3. **결과 시각화**
- 탐지된 객체는 **회전된 바운딩 박스**로 표시됩니다.
- 매칭이 실패할 경우, 화면에 실패 메시지를 출력합니다.

---

## **사용 방법**

1. 프로그램 실행 후, 웹캠 화면에서 탐지할 영역(ROI)을 마우스로 드래그하여 선택합니다.
2. ROI 설정 후, 프로그램이 객체를 탐지하고 회전 각도를 반영하여 결과를 표시합니다.
3. 프로그램을 종료하려면 `q` 키를 누릅니다.

---

## **프로젝트 동작 원리 요약**

1. **ROI 선택**: 마우스를 이용해 관심 영역을 설정.
2. **템플릿 생성**: 다양한 각도로 회전된 템플릿을 생성.
3. **템플릿 매칭**: `matchTemplate`를 통해 현재 프레임과 템플릿을 비교.
4. **결과 표시**: 객체 위치와 회전 각도를 시각화.

---
